<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>ZapManager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-10">
    <div class="max-w-6xl mx-auto space-y-6">
        
        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500 text-center">
            <h2 class="text-xl font-bold mb-4">Conexão WhatsApp</h2>
            <div id="status-container">
                <p id="status-msg" class="font-medium text-gray-600">Verificando...</p>
                <div id="auth-actions" class="mt-4 flex justify-center gap-2">
                    <button onclick="document.getElementById('qr-box').classList.toggle('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded">QR Code</button>
                    <button onclick="document.getElementById('phone-box').classList.toggle('hidden')" class="bg-green-600 text-white px-4 py-2 rounded">Telefone</button>
                </div>
                <div id="qr-box" class="hidden mt-4"><img id="qrcode-img" class="mx-auto border"></div>
                <div id="phone-box" class="hidden mt-4 space-y-2">
                    <input type="text" id="phone-input" placeholder="55119..." class="border p-2 rounded">
                    <button onclick="gerarCode()" class="bg-green-500 text-white px-4 py-2 rounded">Gerar</button>
                    <div id="code-display" class="text-2xl font-mono font-bold mt-2"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">1. Selecione o Grupo</h2>
                <div id="lista-grupos" class="space-y-2 h-[400px] overflow-y-auto text-sm">
                    <p class="text-gray-400 italic">Conecte para ver os grupos...</p>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div id="painel-controle" class="bg-white p-6 rounded-xl shadow-lg opacity-50 pointer-events-none transition-opacity">
                    <h2 class="text-xl font-bold mb-4">Gerenciar: <span id="nome-grupo" class="text-blue-600">Nenhum</span></h2>
                    <input type="hidden" id="chat-id">
                    <div class="space-y-4">
                        <input type="text" id="link-input" placeholder="Link (URL)" class="w-full border p-2 rounded">
                        <textarea id="desc-input" placeholder="Descrição" class="w-full border p-2 rounded"></textarea>
                        <input type="datetime-local" id="data-input" class="w-full border p-2 rounded">
                        <button onclick="agendar()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Agendar Postagem</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Fila de Agendamentos</h2>
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="bg-gray-50 border-b">
                            <th class="p-2">Data</th><th class="p-2">Descrição</th><th class="p-2">Status</th><th class="p-2">Ação</th>
                        </tr></thead>
                        <tbody id="tbody-fila"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selecionado = null;

        async function checarStatus() {
            const res = await fetch('/status-auth');
            const status = await res.json();
            const msg = document.getElementById('status-msg');
            const painel = document.getElementById('painel-controle');

            if (status.conectado) {
                msg.innerHTML = "✅ <span class='text-green-600 font-bold'>Conectado</span>";
                painel.classList.remove('opacity-50', 'pointer-events-none');
                carregarGrupos();
            } else {
                msg.innerHTML = "❌ <span class='text-red-500'>Desconectado</span>";
                if (status.base64) document.getElementById('qrcode-img').src = status.base64;
            }
        }

        async function carregarGrupos() {
            const res = await fetch('/grupos');
            if (!res.ok) return;
            const grupos = await res.json();
            const container = document.getElementById('lista-grupos');
            container.innerHTML = grupos.map(g => `
                <div onclick="selecionarGrupo('${g.id}', '${g.name}')" class="p-2 border rounded cursor-pointer hover:bg-blue-50 transition">
                    ${g.name}
                </div>
            `).join('');
        }

        function selecionarGrupo(id, nome) {
            document.getElementById('chat-id').value = id;
            document.getElementById('nome-grupo').innerText = nome;
            alert("Grupo selecionado: " + nome);
        }

        async function agendar() {
            const data = {
                chatId: document.getElementById('chat-id').value,
                link: document.getElementById('link-input').value,
                descricao: document.getElementById('desc-input').value,
                data: document.getElementById('data-input').value
            };
            const res = await fetch('/agendar-link', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) { alert("Agendado!"); atualizarFila(); }
        }

        async function atualizarFila() {
            const res = await fetch('/listagem-geral');
            const dados = await res.json();
            const tbody = document.getElementById('tbody-fila');
            tbody.innerHTML = dados.map(d => `
                <tr class="border-b text-sm">
                    <td class="p-2">${new Date(d.data_postagem).toLocaleString()}</td>
                    <td class="p-2">${d.descricao || 'Sem desc.'}</td>
                    <td class="p-2">${d.enviado ? '✅' : '⏳'}</td>
                    <td class="p-2"><button onclick="remover(${d.id})" class="text-red-500">Excluir</button></td>
                </tr>
            `).join('');
        }

        async function remover(id) {
            if(confirm("Excluir?")) {
                await fetch(`/remover/link/${id}`, { method: 'DELETE' });
                atualizarFila();
            }
        }

        setInterval(checarStatus, 5000);
        setInterval(atualizarFila, 10000);
        checarStatus();
        atualizarFila();
    </script>
</body>
</html>