<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel WhatsApp Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        
        <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Conexão do Sistema</h2>
            
            <div id="auth-status" class="flex flex-col items-center space-y-4">
                <p id="status-msg" class="text-lg font-medium text-gray-600">Verificando status...</p>
                
                <div id="auth-options" class="flex gap-4">
                    <button onclick="alternarMetodo('qr')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Usar QR Code</button>
                    <button onclick="alternarMetodo('fone')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Usar Telefone</button>
                </div>

                <div id="qr-container" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                    <img id="qrcode-img" src="" alt="QR Code" class="max-w-[250px] border-4 border-white shadow-sm">
                    <p class="text-xs text-gray-500 mt-2 text-center">Escaneie com o seu WhatsApp</p>
                </div>

                <div id="phone-container" class="hidden mt-4 text-center space-y-4">
                    <input type="text" id="phone-number" placeholder="5511999999999" class="border-2 border-gray-300 p-2 rounded-lg w-full text-center text-xl">
                    <button onclick="gerarCodigoPareamento()" class="bg-green-500 text-white w-full py-2 rounded-lg font-bold">Gerar Código de 8 Dígitos</button>
                    <div id="pairing-code-display" class="text-4xl font-mono font-bold text-blue-700 tracking-widest py-4 bg-blue-50 rounded-lg hidden"></div>
                </div>
            </div>
        </div>

        <div id="main-panel" class="opacity-40 pointer-events-none bg-white p-6 rounded-2xl shadow-lg transition-opacity">
            <h2 class="text-xl font-bold mb-4">Novo Agendamento</h2>
            <p class="text-sm text-gray-500">Conecte o WhatsApp para liberar as funções de agendamento.</p>
        </div>

    </div>

    <script>
        function alternarMetodo(metodo) {
            document.getElementById('qr-container').classList.add('hidden');
            document.getElementById('phone-container').classList.add('hidden');
            
            if(metodo === 'qr') document.getElementById('qr-container').classList.remove('hidden');
            if(metodo === 'fone') document.getElementById('phone-container').classList.remove('hidden');
        }

        async function gerarCodigoPareamento() {
            const numero = document.getElementById('phone-number').value;
            const display = document.getElementById('pairing-code-display');
            
            if(!numero) return alert("Digite o número com DDI e DDD (ex: 5511999999999)");
            
            display.innerText = "GERANDO...";
            display.classList.remove('hidden');

            try {
                const res = await fetch('/solicitar-codigo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ numero })
                });
                const data = await res.json();
                if(data.code) {
                    display.innerText = data.code;
                } else {
                    display.innerText = "ERRO";
                }
            } catch (e) {
                display.innerText = "ERRO CONEXÃO";
            }
        }

        async function verificarStatus() {
            try {
                const res = await fetch('/status-auth');
                const status = await res.json();
                
                const msg = document.getElementById('status-msg');
                const painel = document.getElementById('main-panel');
                const opts = document.getElementById('auth-options');

                if (status.conectado) {
                    msg.innerHTML = "✅ <span class='text-green-600 font-bold'>BOT ONLINE</span>";
                    painel.classList.remove('opacity-40', 'pointer-events-none');
                    opts.classList.add('hidden');
                    document.getElementById('qr-container').classList.add('hidden');
                    document.getElementById('phone-container').classList.add('hidden');
                } else {
                    msg.innerHTML = "❌ <span class='text-red-500'>BOT DESCONECTADO</span>";
                    painel.classList.add('opacity-40', 'pointer-events-none');
                    opts.classList.remove('hidden');
                    
                    if(status.base64) {
                        document.getElementById('qrcode-img').src = status.base64;
                    }
                }
            } catch (e) { console.error("Erro ao verificar status"); }
        }

        setInterval(verificarStatus, 5000);
        verificarStatus();
    </script>
</body>
</html>