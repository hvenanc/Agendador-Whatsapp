<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>ZapManager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-4 md:p-10">
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">1. Selecione o Grupo</h2>
            <div id="lista-grupos" class="space-y-2 h-[500px] overflow-y-auto pr-2 text-sm">
                <p class="text-gray-400">Carregando grupos...</p>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div id="painel-controle"
                class="bg-white p-6 rounded-xl shadow-lg opacity-50 pointer-events-none transition-opacity">
                <h2 class="text-xl font-bold mb-4">Gerenciar: <span id="nome-grupo" class="text-blue-600">Nenhum</span>
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3 p-4 border rounded-lg bg-blue-50">
                        <h3 class="font-bold">Agendar Link</h3>
                        <input id="desc-link" type="text" placeholder="Descrição da postagem"
                            class="w-full p-2 border rounded text-sm">
                        <input id="url-link" type="text" placeholder="URL (https://...)"
                            class="w-full p-2 border rounded text-sm">
                        <input id="data-link" type="datetime-local" class="w-full p-2 border rounded text-sm">
                        <button onclick="agendarLink()"
                            class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700">Agendar
                            Link</button>
                    </div>

                    <div class="space-y-3 p-4 border rounded-lg bg-purple-50">
                        <h3 class="font-bold">Agendar Abertura/Fechamento</h3>
                        <select id="acao-status" class="w-full p-2 border rounded text-sm">
                            <option value="abrir">Abrir (Todos falam)</option>
                            <option value="fechar">Fechar (Só ADMs)</option>
                        </select>
                        <textarea id="msg-status" placeholder="Mensagem de aviso..."
                            class="w-full p-2 border rounded text-sm"></textarea>
                        <input id="data-status" type="datetime-local" class="w-full p-2 border rounded text-sm">
                        <button onclick="agendarStatus()"
                            class="w-full bg-purple-600 text-white py-2 rounded font-bold hover:bg-purple-700">Agendar
                            Status</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4">Fila de Execução</h2>
                <div class="overflow-x-auto text-xs">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-2 border">Tipo</th>
                                <th class="p-2 border">Data/Hora</th>
                                <th class="p-2 border">Conteúdo</th>
                                <th class="p-2 border">Status</th>
                                <th class="p-2 border">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-fila"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let grupoAtivo = null;

        async function carregarGrupos() {
            const res = await fetch('/grupos');
            const dados = await res.json();
            const container = document.getElementById('lista-grupos');
            container.innerHTML = '';
            dados.forEach(g => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-3 border rounded hover:bg-blue-50 mb-2";
                b.innerHTML = `<b>${g.name}</b><br><span class="text-[10px] text-gray-400 font-mono">${g.id}</span>`;
                b.onclick = () => {
                    grupoAtivo = g;
                    document.getElementById('nome-grupo').innerText = g.name;
                    document.getElementById('painel-controle').classList.remove('opacity-50', 'pointer-events-none');
                };
                container.appendChild(b);
            });
        }

        async function agendarLink() {
            const dataInput = document.getElementById('data-link').value;
            const linkInput = document.getElementById('url-link').value;

            if (!grupoAtivo || !dataInput || !linkInput) {
                alert("Erro: Certifique-se de selecionar um grupo, inserir um link e uma data válida.");
                return;
            }

            const body = {
                chatId: grupoAtivo.id,
                descricao: document.getElementById('desc-link').value,
                link: linkInput,
                data: dataInput.replace('T', ' ') // Garante formato YYYY-MM-DD HH:mm
            };

            console.log("Enviando para o servidor:", body); // VERIFIQUE ISSO NO CONSOLE DO NAVEGADOR (F12)

            const response = await fetch('/agendar-link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (response.ok) {
                alert("Agendado com sucesso!");
                atualizarFila();
            } else {
                const err = await response.json();
                alert("Erro no servidor: " + err.erro);
            }
        }

        async function agendarStatus() {
            const body = {
                chatId: grupoAtivo.id,
                acao: document.getElementById('acao-status').value,
                mensagem: document.getElementById('msg-status').value,
                data: document.getElementById('data-status').value.replace('T', ' ')
            };
            await fetch('/agendar-status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            alert("Status Agendado!");
            atualizarFila();
        }

        async function atualizarFila() {
            const res = await fetch('/listagem-geral');
            const dados = await res.json();
            const tbody = document.getElementById('tabela-fila');
            tbody.innerHTML = '';
            dados.forEach(d => {
                const enviado = d.enviado || d.executado;
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2 font-bold uppercase">${d.tipo}</td>
                        <td class="p-2">${d.data_postagem || d.data_execucao}</td>
                        <td class="p-2 truncate max-w-[150px]">${d.link || d.mensagem}</td>
                        <td class="p-2">${enviado ? '✅ OK' : '⏳ Pendente'}</td>
                        <td class="p-2">
                            ${!enviado ? `<button onclick="remover('${d.tipo}', ${d.id})" class="text-red-500">Excluir</button>` : '-'}
                        </td>
                    </tr>
                `;
            });
        }

        async function remover(tipo, id) {
            if (confirm("Remover?")) {
                await fetch(`/remover/${tipo}/${id}`, { method: 'DELETE' });
                atualizarFila();
            }
        }

        carregarGrupos();
        atualizarFila();
        setInterval(atualizarFila, 30000);
    </script>
</body>

</html>